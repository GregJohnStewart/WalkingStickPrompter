<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>File Formatter for WalkingStickPrompter</title>
  <style>
  #initialInput {
      width: 100%;
      min-width:100%;
      min-height:200px;
  }
  #outputContainer {
      
  }
  .textView {
    font-family: "Lucida Console", "Courier New", monospace;
  }
  .outputCell {
      border: 1px solid;
      margin: 1px;
      padding: 0px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
  }
  .size2 {/* 15rx26c */
      font-size: 2em;
      width: 26em;
  }
  </style>
</head>
<body>
  <h1>
  File Formatter for WalkingStickPrompter
  </h1>
  <a href="https://github.com/GregJohnStewart/WalkingStickPrompter"></a>
  <p>
    This tool takes a file and formats it for use in the Walking Stick Prompter. Since the microcontroller that runs it is limited, we need to pre format.
  </p>
  <hr />
  
  <h3>Choose a file:</h3>
  <input type="file" id="fileInput" accept=".txt" />
  
  <hr />
  <h3>Input Text:</h3>
  <p>(Tweak this to get the output right!)</p>
  <textarea id="initialInput" class="textView"></textarea>
  <hr />
  <h3>Output:</h3>
  <p>
  Font size:
  <select id="sizeOptions">
    <option data-rows="15" data-cols="26" selected>2</option>
    <option data-rows="10" data-cols="17">3</option>
    <option data-rows="7" data-cols="13">4</option>
    <option data-rows="6" data-cols="10">5</option>
  </select>
  </p>
  <div id="outputContainer"></div>
  
  
  <script>
    var fileInput = document.getElementById('fileInput');
    var initialInput = document.getElementById('initialInput');
    var sizeOptions = document.getElementById('sizeOptions');
    var outputContainer = document.getElementById('outputContainer');
    
    
    const streamToText = async (blob) => {
      const readableStream = await blob.getReader();
      const chunk = await readableStream.read();

      return new TextDecoder('utf-8').decode(chunk.value);
    };

    const bufferToText = (buffer) => {
      const bufferByteLength = buffer.byteLength;
      const bufferUint8Array = new Uint8Array(buffer, 0, bufferByteLength);

      return new TextDecoder().decode(bufferUint8Array);
    };
    
    
    function updateOutput(){
      //TODO:: reformat content
      (async () => {
          let curClass = "size" + sizeOptions.value
          let content = initialInput.value
          
          content = content.replaceAll("\r", "");
          
          //TODO:: parameterize
          content = content.replaceAll("\n\n", "\\n                          ");
          //content = content.replaceAll("\n\n", "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
          content = content.replaceAll("\n", "");
          content = content.replaceAll("\\n", "\n");
      
          
          outputContainer.innerHTML = '';
          
          
          //TODO:: chunk data, make a cell for each page
          let curChunk = document.createElement("div");
          curChunk.classList.add("textView");
          curChunk.classList.add("outputCell");
          curChunk.classList.add(curClass);
          curChunk.innerHTML = content;
          
          
          
          outputContainer.appendChild(curChunk);
      
          console.log("Updated output.");
      })();
    }

    fileInput.addEventListener('change', function(e) {
      let file = fileInput.files[0];

      (async () => {
        const fileContent = await file.text();
        
        initialInput.value = fileContent;
        
        // output.dispatchEvent(new Event('change'));
        
        if ("createEvent" in document) {
          var evt = document.createEvent("HTMLEvents");
          evt.initEvent("change", false, true);
          initialInput.dispatchEvent(evt);
        } else {
          initialInput.fireEvent("onchange");
        }

        console.log("Read in file contents");
      })();
    });

    initialInput.addEventListener('change', function(e) {
      updateOutput();
    });
    sizeOptions.addEventListener('change', function(e) {
      updateOutput();
    });

/*
    document.getElementById('foo').addEventListener('change', function(e) {
      let file = document.getElementById('input').files[0];

      (async () => {
        const fileContent = await file.text();

        console.log('.text()', fileContent);

        const fileContentStream = await file.stream();

        console.log('.stream()', await streamToText(fileContentStream));

        const buffer = await file.arrayBuffer();

        console.log('.buffer()', bufferToText(buffer));

        const fileSliceBlob = file.slice(0, file.length);
        const fileSliceBlobStream = await fileSliceBlob.stream();

        console.log('.slice() and .stream()', await streamToText(fileSliceBlobStream));
        
        document.getElementById('output').value = fileContent;
      })();
    });
    */
  </script>
</body>
</html>
